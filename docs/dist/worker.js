(()=>{"use strict";var t,o,i,e,n;!function(t){t[t.ACTIVE_TAG=1]="ACTIVE_TAG",t[t.ISLAND_SLEEPING=2]="ISLAND_SLEEPING",t[t.WANTS_DEACTIVATION=3]="WANTS_DEACTIVATION",t[t.DISABLE_DEACTIVATION=4]="DISABLE_DEACTIVATION",t[t.DISABLE_SIMULATION=5]="DISABLE_SIMULATION"}(t||(t={})),function(t){t[t.CF_STATIC_OBJECT=1]="CF_STATIC_OBJECT",t[t.CF_KINEMATIC_OBJECT=2]="CF_KINEMATIC_OBJECT",t[t.CF_NO_CONTACT_RESPONSE=4]="CF_NO_CONTACT_RESPONSE",t[t.CF_CUSTOM_MATERIAL_CALLBACK=8]="CF_CUSTOM_MATERIAL_CALLBACK",t[t.CF_CHARACTER_OBJECT=16]="CF_CHARACTER_OBJECT",t[t.CF_DISABLE_VISUALIZE_OBJECT=32]="CF_DISABLE_VISUALIZE_OBJECT",t[t.CF_DISABLE_SPU_COLLISION_PROCESSING=64]="CF_DISABLE_SPU_COLLISION_PROCESSING"}(o||(o={})),function(t){t[t.Environment=1]="Environment",t[t.Other=2]="Other"}(i||(i={})),function(t){t[t.Environment=2]="Environment",t[t.Other=3]="Other"}(e||(e={}));class s{constructor(t,o,i,e){this._colShape=t,this._options=e,this._transform=new Ammo.btTransform,this._localInertia=new Ammo.btVector3(0,0,0);const{mass:n,friction:s,restitution:r,activationState:a,collisionFlag:d}=this._options;this._transform.setIdentity(),this._transform.setOrigin(o),this._transform.setRotation(i),this._motionState=new Ammo.btDefaultMotionState(this._transform),0!==n&&this._colShape.calculateLocalInertia(n,this._localInertia),this._rbInfo=new Ammo.btRigidBodyConstructionInfo(n,this._motionState,this._colShape,this._localInertia),this._rigidBody=new Ammo.btRigidBody(this._rbInfo),void 0!==s&&this._rigidBody.setFriction(s),void 0!==r&&this._rigidBody.setRestitution(r),void 0!==a&&this._rigidBody.setActivationState(a),void 0!==d&&this._rigidBody.setCollisionFlags(d)}getMotionState(){return this._rigidBody.getMotionState()}getOrigin(){return this._rigidBody.getWorldTransform().getOrigin()}getRotation(){return this._rigidBody.getWorldTransform().getRotation()}add(t){const{collisionFilterGroup:o,collisionFilterMask:i}=this._options;void 0!==o&&void 0!==i?t.addRigidBody(this._rigidBody,o,i):t.addRigidBody(this._rigidBody)}remove(t){t.removeRigidBody(this._rigidBody)}destroy(){Ammo.destroy(this._rigidBody),Ammo.destroy(this._rbInfo),Ammo.destroy(this._motionState),Ammo.destroy(this._transform),Ammo.destroy(this._localInertia)}}!function(t){t[t.None=0]="None",t[t.Debug=1]="Debug",t[t.Info=2]="Info",t[t.Warn=3]="Warn",t[t.Error=4]="Error",t[t.Fatal=5]="Fatal",t[t.All=6]="All"}(n||(n={}));const r=["#ffffff","#00ff00","#00ffff","#ffff00","#ff00ff","#ff0000","#ffffff"],a=n.Fatal,d=n.Error;function c(t,o,...i){if(!(o>a)&&(console.log(`%c ${t}`,`color: ${r[o]}`,...i),o>=d))throw t}var l;!function(t){t[t.Main=0]="Main",t[t.Worker=1]="Worker"}(l||(l={}));const m=["#660000","#000066"];function _(t,o,i,...e){if(!(o>a)&&(console.log(`%c ${t}`,`color: ${r[o]}; background: ${m[i]}`,...e),o>=d))throw t}function A(){return void 0!==performance?performance.now():Date.now()}function h(t,o){return Math.random()*(o-t)+t}let f,u;var C;!function(t){t[t.Render=0]="Render",t[t.Step=1]="Step",t[t.Add=2]="Add",t[t.Remove=3]="Remove"}(C||(C={})),importScripts("../lib/ammo/ammo.wasm.js");const S=new class{constructor(t){this._fixedTimeStep=1/60,this._accumulator=0,this._maxSteps=4,this._maxSubSteps=0,this._onPhysicsUpdate=(t,o)=>{},this._rigidBodies=new Array,this._motionStates=new Array,this._didAdd=!1,this.init(t)}set onPhysicsUpdate(t){this._onPhysicsUpdate=t}async init(t){try{"function"==typeof Ammo&&(void 0!==t?await Ammo({locateFile:()=>t}):await Ammo()),f={btVector3A:new Ammo.btVector3(0,0,0),btVector3B:new Ammo.btVector3(0,0,0),btTransformA:new Ammo.btTransform,btQuaternionA:new Ammo.btQuaternion(0,0,0,1)},u={concreteContactResultCallback:new Ammo.ConcreteContactResultCallback,concreteContactPosition:new Ammo.btVector3(0,0,0),concreteContactResult:!1,closestRayResultCallback:new Ammo.ClosestRayResultCallback(f.btVector3A,f.btVector3B)};const o=new Ammo.btDefaultCollisionConfiguration,i=new Ammo.btCollisionDispatcher(o),e=new Ammo.btDbvtBroadphase,n=new Ammo.btSequentialImpulseConstraintSolver;this._dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(i,e,n,o);const{btVector3A:s}=f;s.setValue(0,-9.8,0),this._dynamicsWorld.setGravity(s),this.setupCallbacks(),this.loadEnvironment()}catch(t){console.log("init(): err",t)}}setupCallbacks(){const{concreteContactResultCallback:t,concreteContactPosition:o}=u;t.addSingleResult=(t,i,e,s,r,a,d)=>{const l=Ammo.wrapPointer(t,Ammo.btManifoldPoint),m=l.getDistance();if(m>0)return c(`concreteContactResultCallback.addSingleResult(): distance ${m} > 0`,n.Warn),0;const _=Ammo.wrapPointer(i,Ammo.btCollisionObjectWrapper),A=Ammo.castObject(_.getCollisionObject(),Ammo.btRigidBody),h=Ammo.wrapPointer(r,Ammo.btCollisionObjectWrapper),f=Ammo.castObject(h.getCollisionObject(),Ammo.btRigidBody);c("concreteContactResultCallback.addSingleResult(): colObj0, rb0",n.Debug,_,A),c("concreteContactResultCallback.addSingleResult(): colObj1, rb1",n.Debug,h,f);const C=l.getPositionWorldOnA();return o.setValue(C.x(),C.y(),C.z()),u.concreteContactResult=!0,0}}loadEnvironment(){if(void 0===this._dynamicsWorld)return void c("loadEnvironment(): _dynamicsWorld === undefined",n.Error);const{btVector3A:r,btQuaternionA:a}=f;r.setValue(25,.5,25);const d=new Ammo.btBoxShape(r);r.setValue(0,-.5,0),a.setValue(0,0,0,1),new s(d,r,a,{mass:0,friction:1,restitution:.5,activationState:t.DISABLE_DEACTIVATION,collisionFlag:o.CF_STATIC_OBJECT,collisionFilterGroup:i.Environment,collisionFilterMask:e.Environment}).add(this._dynamicsWorld),r.setValue(5,.5,10);const l=new Ammo.btBoxShape(r);r.setValue(-10,0,0),a.setEulerZYX(0,0,-Math.PI/6),new s(l,r,a,{mass:0,friction:1,restitution:.5,activationState:t.DISABLE_DEACTIVATION,collisionFlag:o.CF_STATIC_OBJECT,collisionFilterGroup:i.Environment,collisionFilterMask:e.Environment}).add(this._dynamicsWorld)}add(o){if(c("add()",n.Debug),void 0===this._dynamicsWorld)return void c("add(): _dynamicsWorld === undefined",n.Error);const{btVector3A:r,btQuaternionA:a}=f;r.setValue(.25,.5,.5);const d=new Ammo.btBoxShape(r);this._rigidBodies=new Array(o),this._motionStates=new Array(o);for(let n=0;n<o;n++){r.setValue(h(-10,10),50,h(-10,10)),a.setEulerZYX(h(-Math.PI,Math.PI),h(-Math.PI,Math.PI),h(-Math.PI,Math.PI));const o=new s(d,r,a,{mass:1,friction:1,restitution:.5,activationState:t.DISABLE_DEACTIVATION,collisionFilterGroup:i.Other,collisionFilterMask:e.Other});o.add(this._dynamicsWorld),this._rigidBodies[n]=o}this._didAdd=!0}remove(){if(void 0!==this._dynamicsWorld){for(const t of this._rigidBodies)t.remove(this._dynamicsWorld),t.destroy();this._rigidBodies=[],this._motionStates=[],this._didAdd=!1}else c("remove(): _dynamicsWorld === undefined",n.Error)}onRenderUpdate(t){if(void 0===this._dynamicsWorld)return void c("onRenderUpdate(): _dynamicsWorld === undefined",n.Warn);t=Math.max(.001,Math.min(t,1)),this._accumulator+=t;const{btTransformA:o}=f;let i=0;for(;this._accumulator>=this._fixedTimeStep&&i<this._maxSteps;){const t=A();if(this._dynamicsWorld.stepSimulation(this._fixedTimeStep,this._maxSubSteps),this._didAdd)for(const[t,i]of this._rigidBodies.entries()){if(void 0===i)break;const e=i.getMotionState();if(e){e.getWorldTransform(o);const i=o.getOrigin(),n=o.getRotation();this._motionStates[t]={position:{x:i.x(),y:i.y(),z:i.z()},rotation:{x:n.x(),y:n.y(),z:n.z(),w:n.w()}}}else c("onRenderUpdate(): !motionState",n.Error)}this._onPhysicsUpdate([...this._motionStates],A()-t),this._accumulator-=this._fixedTimeStep,i++}}};_("worker: physics:",n.Info,l.Worker,S);let I=0;self.onmessage=t=>{_(`messageNum: ${I}`,n.Debug,l.Worker);const o=t.data;switch(o.type){case C.Render:S.onRenderUpdate(o.data);break;case C.Step:break;case C.Add:S.add(o.data),_("WORKER: MessageType.Add",n.Info,l.Worker);break;case C.Remove:S.remove()}I++},S.onPhysicsUpdate=(t,o)=>{const i={type:C.Step,data:{motionStates:t,physicsStepComputeTime:o}};self.postMessage(i)}})();